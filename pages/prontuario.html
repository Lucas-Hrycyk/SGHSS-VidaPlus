<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário do Paciente - SGHSS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#" id="back-link">Voltar ao Painel</a>
            <button class="btn btn-danger" onclick="logoutUser()">Sair</button>
        </div>
    </nav>
    <div class="container mt-5">
        <h3 id="prontuario-title"></h3>
        <div id="doctor-form-area" class="card p-3 mb-4" style="display: none;">
            <h5>Adicionar Nova Nota ao Prontuário</h5>
            <form id="prontuario-form">
                <div class="mb-3"><textarea id="entry-text" class="form-control" rows="3" required placeholder="Digite a nova anotação..."></textarea></div>
                <button type="submit" class="btn btn-info text-white">Salvar Nota</button>
            </form>
        </div>
        <h4>Histórico de Atendimentos</h4>
        <div id="prontuario-list" class="list-group"></div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/database.js"></script>
    <script>
        protectPage(['paciente', 'medico']);
        const currentUser = getCurrentUser();
        const allUsers = JSON.parse(localStorage.getItem('sghss_users')) || [];

        function findUserByEmail(email) {
            return allUsers.find(user => user.email === email);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const patientEmail = urlParams.get('paciente');

        const patient = findUserByEmail(patientEmail);
        const patientName = patient ? patient.nome : patientEmail;

        document.getElementById('back-link').href = `dashboard-${currentUser.role}.html`;
        document.getElementById('prontuario-title').innerText = `Prontuário de: ${patientName}`;

        if (currentUser.role === 'medico') {
            document.getElementById('doctor-form-area').style.display = 'block';
        }

        function renderProntuario() {
            const prontuarioList = document.getElementById('prontuario-list');
            prontuarioList.innerHTML = '';
            const entries = getProntuario(patientEmail).sort((a,b) => new Date(b.date) - new Date(a.date));
            if (entries.length === 0) {
                prontuarioList.innerHTML = '<div class="list-group-item"><p class="text-muted">Nenhum registro encontrado para este paciente.</p></div>';
            } else {
                entries.forEach(entry => {
                    const doctor = findUserByEmail(entry.doctor);
                    const doctorName = doctor ? `Dr(a). ${doctor.nome}` : entry.doctor;

                    prontuarioList.innerHTML += `
                        <div class="list-group-item">
                            <p class="mb-1">${entry.text}</p>
                            <small class="text-muted">Registrado por ${doctorName} em ${new Date(entry.date).toLocaleString('pt-BR')}</small>
                        </div>`;
                });
            }
        }
        
        document.getElementById('prontuario-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const entryText = document.getElementById('entry-text').value;
            if(entryText.trim() === '') return;
            saveProntuarioEntry(patientEmail, entryText);
            document.getElementById('entry-text').value = ''; 
            renderProntuario(); 
        });

        renderProntuario();
    </script>
</body>
</html>