<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Painel do Administrador - SGHSS VidaPlus</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    pre {
      background: #f8f9fa;
      padding: 15px;
      border: 1px solid #dee2e6;
      border-radius: 5px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .nav-tabs .nav-link {
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
    <div class="container">
      <a class="navbar-brand" href="#">Painel Administrador</a>
      <button class="btn btn-danger" onclick="logoutUser()">Sair</button>
    </div>
  </nav>

  <div class="container mt-4">
    <h3 id="welcome-message"></h3>
    <ul class="nav nav-tabs" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#usuarios" type="button">Usuários</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#hospitalar" type="button">Adm. Hospitalar</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#prontuarios" type="button">Prontuários</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#consultas" type="button">Consultas</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#relatorios" type="button">Relatórios</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#auditoria" type="button">Auditoria</button></li>
      <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#acesso" type="button">Logs de Acesso</button></li>
    </ul>

    <div class="tab-content mt-3 p-3 border border-top-0 rounded-bottom">
      <div class="tab-pane fade show active" id="usuarios" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4>Usuários do Sistema</h4>
          <button class="btn btn-primary" onclick="showAddUserModal()">Adicionar Usuário</button>
        </div>
        <input type="text" id="filtro-usuarios" placeholder="Buscar por nome, email ou perfil..." class="form-control mb-3" oninput="renderUsers()"/>
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead class="table-dark"><tr><th>Nome</th><th>Email</th><th>Perfil</th><th class="text-center">Ações</th></tr></thead>
            <tbody id="users-table-body"></tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="hospitalar" role="tabpanel">
        <h4>Status dos Leitos</h4>
        <p class="text-muted small">Visualização em tempo real do status dos leitos.</p>
        <div id="leitos-view" class="d-flex flex-wrap gap-2 border p-3 rounded bg-light"></div>
      </div>

      <div class="tab-pane fade" id="prontuarios" role="tabpanel">
        <h4>Buscar Prontuário de Paciente</h4>
        <div class="input-group mb-3">
          <input type="text" id="prontuario-search" placeholder="Buscar por Nome, CPF ou Email do paciente" class="form-control" />
          <button class="btn btn-info text-white" onclick="buscarProntuario()">Buscar</button>
        </div>
        <div id="prontuario-result"></div>
      </div>

      <div class="tab-pane fade" id="consultas" role="tabpanel">
        <h4>Consultas Agendadas</h4>
        <div class="table-responsive">
          <table class="table table-striped">
            <thead class="table-light"><tr><th>Paciente</th><th>Especialidade</th><th>Tipo</th><th>Data e Hora</th><th>Status</th></tr></thead>
            <tbody id="consultas-table-body"></tbody>
          </table>
        </div>
      </div>

      <div class="tab-pane fade" id="relatorios" role="tabpanel">
          <h4>Geração de Relatórios</h4>
          <div class="d-flex gap-2 mb-3">
              <button class="btn btn-secondary" onclick="generateAppointmentsReport()">Consultas por Especialidade</button>
              <button class="btn btn-secondary" onclick="generateBedsReport()">Ocupação de Leitos</button>
          </div>
          <div id="report-output" class="p-3 border rounded bg-light">
              <p class="text-muted">Selecione um relatório para gerar.</p>
          </div>
      </div>

      <div class="tab-pane fade" id="auditoria" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4>Logs de Atividade de Auditoria</h4>
          <button class="btn btn-warning" onclick="limparLogs('sghss_logs', 'Atividades de Auditoria')">Limpar Logs de Atividade</button>
        </div>
        <pre id="logs"></pre>
      </div>

      <div class="tab-pane fade" id="acesso" role="tabpanel">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4>Logs de Acesso ao Sistema</h4>
          <button class="btn btn-warning" onclick="limparLogs('sghss_access_logs', 'Acesso ao Sistema')">Limpar Logs de Acesso</button>
        </div>
        <pre id="access-logs"></pre>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalAddUser" tabindex="-1">
    <div class="modal-dialog">
      <form class="modal-content" id="form-add-user" onsubmit="adicionarUsuario(event)">
        <div class="modal-header">
          <h5 class="modal-title">Adicionar Usuário</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3"><label class="form-label">Nome Completo</label><input type="text" id="nome-add-user" class="form-control" required /></div>
          <div class="mb-3"><label class="form-label">CPF</label><input type="text" id="cpf-add-user" class="form-control" required /></div>
          <div class="mb-3"><label class="form-label">Email</label><input type="email" id="email-add-user" class="form-control" required /></div>
          <div class="mb-3"><label class="form-label">Senha</label><input type="password" id="senha-add-user" class="form-control" required /></div>
          <div class="mb-3"><label class="form-label">Confirmar Senha</label><input type="password" id="confirm-senha-add-user" class="form-control" required /></div>
          <div class="mb-3">
            <label class="form-label">Perfil</label>
            <select id="role-add-user" class="form-select" required>
              <option value="" disabled selected>Selecione</option>
              <option value="paciente">Paciente</option>
              <option value="medico">Médico</option>
              <option value="enfermeiro">Enfermeiro(a)</option>
              <option value="tecnico_enfermagem">Técnico(a) de Enfermagem</option>
              <option value="admin">Administrador</option>
            </select>
          </div>
          <div class="mb-3" id="specialty-add-user-field" style="display: none;">
            <label for="specialty-add-user" class="form-label">Especialidade</label>
            <select id="specialty-add-user" class="form-select">
              <option value="" selected disabled>Selecione</option>
              <option value="Cardiologia">Cardiologia</option>
              <option value="Clínica Geral">Clínica Geral</option>
              <option value="Dermatologia">Dermatologia</option>
              <option value="Ortopedia">Ortopedia</option>
              <option value="Pediatria">Pediatria</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Adicionar</button>
        </div>
      </form>
    </div>
  </div>

  <script src="../assets/js/auth.js"></script>
  <script src="../assets/js/database.js"></script>
  <script src="../assets/js/hospital.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    protectPage(['admin']);
    const currentUser = getCurrentUser();
    document.getElementById('welcome-message').innerText = `Bem-vindo(a), Admin ${currentUser.nome}!`;
    const userModal = new bootstrap.Modal(document.getElementById('modalAddUser'));
    const roleAddUserSelect = document.getElementById('role-add-user');
    const specialtyAddUserField = document.getElementById('specialty-add-user-field');

    function renderAllLogs() {
        const activityLogs = JSON.parse(localStorage.getItem('sghss_logs')) || [];
        document.getElementById('logs').textContent = activityLogs.join('\n') || 'Nenhum log de atividade registrado.';

        const accessLogs = JSON.parse(localStorage.getItem('sghss_access_logs')) || [];
        document.getElementById('access-logs').textContent = accessLogs.join('\n') || 'Nenhum log de acesso registrado.';
    }

    function logAction(action) {
      let logs = JSON.parse(localStorage.getItem('sghss_logs')) || [];
      logs.unshift(`[${new Date().toLocaleString('pt-BR')}] Admin: ${currentUser.email} -> ${action}`);
      localStorage.setItem('sghss_logs', JSON.stringify(logs));
      renderAllLogs();
    }
    
    function limparLogs(logKey, logName) {
      if (confirm(`Tem certeza que deseja limpar todos os logs de ${logName}?`)) {
        localStorage.removeItem(logKey);
        if (logKey === 'sghss_logs') {
          logAction(`Logs de '${logName}' foram limpos.`);
        } else {
          renderAllLogs();
        }
      }
    }

    roleAddUserSelect.addEventListener('change', function() {
      specialtyAddUserField.style.display = (this.value === 'medico') ? 'block' : 'none';
      document.getElementById('specialty-add-user').required = (this.value === 'medico');
    });

    function getRoleBadge(role) {
      const roles = { admin: 'bg-danger', medico: 'bg-info', paciente: 'bg-secondary', enfermeiro: 'bg-success', tecnico_enfermagem: 'bg-warning text-dark' };
      return roles[role] || 'bg-light text-dark';
    }

    function renderUsers() {
      const users = JSON.parse(localStorage.getItem('sghss_users')) || [];
      const filtro = document.getElementById('filtro-usuarios').value.toLowerCase();
      const tbody = document.getElementById('users-table-body');
      tbody.innerHTML = '';
      users.filter(u => u.nome.toLowerCase().includes(filtro) || u.email.toLowerCase().includes(filtro) || u.role.toLowerCase().includes(filtro))
      .forEach(user => {
        const index = users.findIndex(u => u.email === user.email);
        const roleName = user.role.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        tbody.innerHTML += `<tr><td>${user.nome}</td><td>${user.email}</td><td><span class="badge ${getRoleBadge(user.role)}">${roleName}</span></td><td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="removerUsuario(${index})">X</button></td></tr>`;
      });
    }

    function removerUsuario(index) {
      let users = JSON.parse(localStorage.getItem('sghss_users')) || [];
      const userToRemove = users[index];
      if (confirm(`Remover ${userToRemove.nome}?`)) {
        users.splice(index, 1);
        localStorage.setItem('sghss_users', JSON.stringify(users));
        logAction(`Usuário removido: ${userToRemove.email}`);
        renderUsers();
      }
    }
    
    function showAddUserModal() {
      document.getElementById('form-add-user').reset();
      specialtyAddUserField.style.display = 'none';
      document.getElementById('specialty-add-user').removeAttribute('required');
      userModal.show();
    }

    function adicionarUsuario(event) {
      event.preventDefault();
      const senha = document.getElementById('senha-add-user').value;
      const confirmSenha = document.getElementById('confirm-senha-add-user').value;
      if (senha !== confirmSenha) { alert('As senhas não coincidem!'); return; }
      
      const email = document.getElementById('email-add-user').value;
      const res = registerUser(
          document.getElementById('nome-add-user').value,
          document.getElementById('cpf-add-user').value,
          email,
          senha,
          document.getElementById('role-add-user').value,
          document.getElementById('specialty-add-user').value
      );
      if(res === true) {
          logAction(`Usuário criado: ${email}`);
          renderUsers();
          userModal.hide();
      } else {
          alert(res);
      }
    }

    function renderLeitos() {
        const leitos = getLeitos();
        const leitosDiv = document.getElementById('leitos-view');
        leitosDiv.innerHTML = '';
        if (!leitos.length) { leitosDiv.innerHTML = '<p class="text-muted">Sistema de leitos não inicializado.</p>'; return; }
        leitos.forEach(leito => {
            const badgeClass = leito.status === 'Ocupado' ? 'bg-danger' : 'bg-success';
            leitosDiv.innerHTML += `<span class="badge fs-6 p-2 ${badgeClass}">Leito ${leito.id}</span>`;
        });
    }

    function buscarProntuario() {
      const searchTerm = document.getElementById('prontuario-search').value.trim().toLowerCase();
      const resultDiv = document.getElementById('prontuario-result');
      if (!searchTerm) { resultDiv.innerHTML = '<div class="alert alert-warning">Digite um termo para busca.</div>'; return; }
      
      const allUsers = JSON.parse(localStorage.getItem('sghss_users')) || [];
      const matchedUser = allUsers.find(user => user.role === 'paciente' && (user.nome.toLowerCase().includes(searchTerm) || user.email.toLowerCase() === searchTerm || user.cpf.replace(/[.\-]/g, '') === searchTerm.replace(/[.\-]/g, '')));
      
      if(!matchedUser){
        resultDiv.innerHTML='<div class="alert alert-info">Nenhum paciente encontrado.</div>';
        return;
      }
      
      logAction(`Busca de prontuário para: "${searchTerm}"`);
      const entries = getProntuario(matchedUser.email);
      let html = `<div class="card mb-3"><div class="card-header"><strong>Paciente:</strong> ${matchedUser.nome}</div>`;
      if(entries.length > 0){
        html += '<div class="list-group list-group-flush">';
        entries.forEach(entry => {
          const doc = allUsers.find(u => u.email === entry.doctor);
          html += `<div class="list-group-item"><p class="mb-1">${entry.text}</p><small class="text-muted">Por ${doc?doc.nome:entry.doctor} em ${new Date(entry.date).toLocaleString('pt-BR')}</small></div>`;
        });
        html += '</div>';
      } else {
        html += '<div class="card-body"><p class="text-muted">Nenhum registro para este paciente.</p></div>';
      }
      html += '</div>';
      resultDiv.innerHTML = html;
    }
    
    function getStatusBadgeConsultas(status) {
        const statuses = { 'Pendente': 'bg-warning text-dark', 'Confirmada': 'bg-success', 'Cancelada': 'bg-danger', 'Realizada': 'bg-secondary' };
        return `<span class="badge ${statuses[status] || 'bg-light text-dark'}">${status}</span>`;
    }
    
    function renderConsultas() {
      const users = JSON.parse(localStorage.getItem('sghss_users')) || [];
      const appointments = getAppointments().sort((a,b) => new Date(b.date) - new Date(a.date));
      const tbody = document.getElementById('consultas-table-body');
      tbody.innerHTML = '';
      appointments.forEach(app => {
        const patient = users.find(u => u.email === app.patientEmail);
        const finalStatus = new Date(app.date) < new Date() && app.status !== 'Cancelada' ? 'Realizada' : app.status;
        tbody.innerHTML += `<tr><td>${patient ? patient.nome : app.patientEmail}</td><td>${app.specialty}</td><td>${app.type}</td><td>${new Date(app.date).toLocaleString('pt-BR')}</td><td>${getStatusBadgeConsultas(finalStatus)}</td></tr>`;
      });
    }
    
    function generateAppointmentsReport() {
        const appointments = getAppointments();
        const reportDiv = document.getElementById('report-output');
        if (appointments.length === 0) { reportDiv.innerHTML = '<p class="text-muted">Nenhuma consulta para gerar relatório.</p>'; return; }
        const bySpecialty = appointments.reduce((acc, curr) => { acc[curr.specialty] = (acc[curr.specialty] || 0) + 1; return acc; }, {});
        let html = '<h5>Consultas Agendadas por Especialidade</h5><ul class="list-group">';
        for (const specialty in bySpecialty) { html += `<li class="list-group-item d-flex justify-content-between align-items-center">${specialty}<span class="badge bg-primary rounded-pill">${bySpecialty[specialty]}</span></li>`; }
        html += '</ul>';
        reportDiv.innerHTML = html;
    }

    function generateBedsReport() {
        const leitos = getLeitos();
        const reportDiv = document.getElementById('report-output');
        const ocupados = leitos.filter(l => l.status === 'Ocupado').length;
        const livres = leitos.length - ocupados;
        const percentOcupados = leitos.length > 0 ? (ocupados / leitos.length) * 100 : 0;
        reportDiv.innerHTML = `<h5>Relatório de Ocupação de Leitos</h5><p>Total de Leitos: <strong>${leitos.length}</strong> | Ocupados: <strong class="text-danger">${ocupados}</strong> | Livres: <strong class="text-success">${livres}</strong></p><div class="progress" role="progressbar"><div class="progress-bar bg-danger" style="width: ${percentOcupados}%">${Math.round(percentOcupados)}%</div></div>`;
    }

    function init() {
      renderUsers();
      renderConsultas();
      renderAllLogs();
      renderLeitos();
    }

    window.addEventListener('storage', (event) => {
      if (['sghss_leitos', 'sghss_users', 'sghss_appointments', 'sghss_logs', 'sghss_access_logs'].includes(event.key)) {
        init();
      }
    });

    init();
  </script>
</body>
</html>